package com.aspectsecurity.contrast.contrastjenkins;

import com.contrastsecurity.http.TraceFilterForm;
import com.contrastsecurity.models.Traces;
import com.contrastsecurity.sdk.ContrastSDK;
import com.google.inject.Inject;
import hudson.AbortException;
import hudson.Extension;
import hudson.model.Run;
import hudson.model.TaskListener;
import jenkins.model.Jenkins;
import lombok.Getter;
import org.jenkinsci.plugins.workflow.steps.AbstractStepDescriptorImpl;
import org.jenkinsci.plugins.workflow.steps.AbstractStepImpl;
import org.jenkinsci.plugins.workflow.steps.AbstractSynchronousNonBlockingStepExecution;
import org.jenkinsci.plugins.workflow.steps.StepContextParameter;
import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.DataBoundSetter;

import java.util.Collections;
import java.util.logging.Logger;

@Getter
public class VulnerabilityTrendStep extends AbstractStepImpl {

    private static final Logger logger = Logger.getLogger(VulnerabilityTrendStep.class.getName());

    private String profileName;

    @DataBoundSetter
    public void setProfileName(String profileName) {
        this.profileName = profileName;
    }

    private String countThreshold;

    @DataBoundSetter
    public void setCountThreshold(String countThreshold) {
        this.countThreshold = countThreshold;
    }

    private String rule;

    @DataBoundSetter
    public void setRule(String rule) {
        this.rule = rule;
    }

    private String severity;

    @DataBoundSetter
    public void setSeverity(String severity) {
        this.severity = severity;
    }

    @DataBoundConstructor
    public VulnerabilityTrendStep() {

    }

    @Override
    public VulnerabilityTrendStepDescriptorImpl getDescriptor() {
        Jenkins instance = Jenkins.getInstance();

        if (instance != null) {
            return (VulnerabilityTrendStepDescriptorImpl) instance.getDescriptor(getClass());
        } else {
            return null;
        }
    }

    @Extension
    public static class VulnerabilityTrendStepDescriptorImpl extends AbstractStepDescriptorImpl {

        public VulnerabilityTrendStepDescriptorImpl() {
            super(Execution.class);
        }

        @Override
        public String getFunctionName() {
            return "contrastVerification";
        }

        @Override
        public String getDisplayName() {
            return "Verify vulnerabilities in a build";
        }
    }

    public static class Execution extends AbstractSynchronousNonBlockingStepExecution<Void> {
        private static final long serialVersionUID = 1L;

        @StepContextParameter
        private transient TeamServerProfile teamServerProfile;

        @StepContextParameter
        private transient Run<?, ?> build;

        @StepContextParameter
        private transient TaskListener taskListener;

        @Inject
        private transient VulnerabilityTrendStep step;

        private void readGlobalConfiguration() {
            teamServerProfile = VulnerabilityTrendHelper.getProfile(step.getProfileName());
        }

        @Override
        public Void run() throws Exception {

            this.readGlobalConfiguration();

            VulnerabilityTrendHelper.logMessage(taskListener, "Checking the number of vulnerabilities for this application.");
            ContrastSDK contrastSDK;
            Traces traces;

            contrastSDK = VulnerabilityTrendHelper.createSDK(teamServerProfile.getUsername(), teamServerProfile.getServiceKey(), teamServerProfile.getApiKey(), teamServerProfile.getTeamServerUrl());

            VulnerabilityTrendHelper.logMessage(taskListener, "Checking the step condition where " + step.getCountThreshold());

            try {
                TraceFilterForm filterForm = new TraceFilterForm();
                filterForm.setAppVersionTags(Collections.singletonList(VulnerabilityTrendHelper.buildAppVersionTag(build)));

                if (step.getSeverity() != null) {
                    filterForm.setSeverities(VulnerabilityTrendHelper.getSeverityList(step.getSeverity()));
                }

                if (step.getRule() != null) {
                    filterForm.setVulnTypes(Collections.singletonList(step.getRule()));
                }

                traces = contrastSDK.getTracesInOrg(teamServerProfile.getOrgUuid(), filterForm);
            } catch (Exception e) {
                VulnerabilityTrendHelper.logMessage(taskListener, e.getMessage());
                throw new AbortException("Unable to retrieve vulnerability information from TeamServer.");
            }

            int thresholdCount = Integer.parseInt(step.getCountThreshold());

            if (traces.getCount() > thresholdCount) {

                throw new AbortException("Failed on the step condition where " + step.getCountThreshold());
            }

            VulnerabilityTrendHelper.logMessage(taskListener, "This step has passed successfully");

            return null;
        }
    }
}