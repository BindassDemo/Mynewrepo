package com.aspectsecurity.contrast.contrastjenkins;


import com.contrastsecurity.exceptions.UnauthorizedException;
import com.contrastsecurity.http.RuleSeverity;
import com.contrastsecurity.http.ServerFilterForm;
import com.contrastsecurity.models.Application;
import com.contrastsecurity.models.Applications;
import com.contrastsecurity.models.Rules;
import com.contrastsecurity.models.Servers;
import com.contrastsecurity.sdk.ContrastSDK;
import hudson.AbortException;
import hudson.model.TaskListener;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.EnumSet;
import java.util.List;

public class VulnerabilityTrendHelper {

    public static ContrastSDK createSDK(String username, String serviceKey, String apiKey, String teamServerUrl) {
        return new ContrastSDK(username, serviceKey, apiKey, teamServerUrl);
    }

    public static TeamServerProfile getProfile(String profileName) {
        final TeamServerProfile[] profiles = new ContrastPluginConfig.ContrastPluginConfigDescriptor().getTeamServerProfiles();

        if (profileName == null && profiles.length > 0)
            return profiles[0];

        for (TeamServerProfile profile : profiles) {
            if (profile.getName().equals(profileName))
                return profile;
        }
        return null;
    }

    /**
     * Helper method for logging messages.
     *
     * @param listener Listener
     * @param msg      String to log
     */
    public static void logMessage(TaskListener listener, String msg) {
        listener.getLogger().println("[Contrast] - " + msg);
    }

    /**
     * Returns the sublist of severities greater than or equal to the configured severity level
     *
     * @param severity include severity to filter with severity list with
     * @return list of severity strings
     */
    public static EnumSet<RuleSeverity> getSeverityList(String severity) {

        List<String> severityList = SEVERITIES.subList(SEVERITIES.indexOf(severity), SEVERITIES.size());

        List<RuleSeverity> ruleSeverities = new ArrayList<>();

        for (String severityToAdd : severityList) {
            ruleSeverities.add(RuleSeverity.valueOf(severityToAdd.toUpperCase()));
        }

        return EnumSet.copyOf(ruleSeverities);
    }

    /**
     * Retrieves the application id by application name; else null
     *
     * @param sdk             Contrast SDK object
     * @param applicationName application name to filter on
     * @return String of the application
     * @throws AbortException
     */
    public static String getApplicationId(ContrastSDK sdk, String organizationUuid, String applicationName) throws AbortException {

        Applications applications;

        try {
            applications = sdk.getApplications(organizationUuid);
        } catch (IOException e) {
            throw new AbortException("Unable to retrieve the applications.");
        } catch (UnauthorizedException e) {
            throw new AbortException("Unable to connect to TeamServer.");
        }

        for (Application application : applications.getApplications()) {
            if (applicationName.equals(application.getName())) {
                return application.getId();
            }
        }

        throw new AbortException("Application with name '" + applicationName + "' not found.");
    }

    /**
     * Retrieves the server id by server name
     *
     * @param sdk              Contrast SDK object
     * @param organizationUuid uuid of the organization
     * @param serverName       name of the server to filter on
     * @param applicationId    application id to filter on
     * @return Long id of the server
     * @throws AbortException
     */
    public static long getServerId(ContrastSDK sdk, String organizationUuid, String serverName, String applicationId) throws AbortException {
        ServerFilterForm serverFilterForm = new ServerFilterForm();
        serverFilterForm.setApplicationIds(Collections.singletonList(applicationId));
        serverFilterForm.setQ(serverName);

        Servers servers;
        long serverId;

        try {
            servers = sdk.getServersWithFilter(organizationUuid, serverFilterForm);
        } catch (IOException e) {
            throw new AbortException("Unable to retrieve the servers.");
        } catch (UnauthorizedException e) {
            throw new AbortException("Unable to connect to TeamServer.");
        }

        if (!servers.getServers().isEmpty()) {
            serverId = servers.getServers().get(0).getServerId();
        } else {
            throw new AbortException("Server with name '" + serverName + "' not found.");
        }

        return serverId;
    }

    /**
     * Retrieves the enabled rules for an organization
     *
     * @param sdk              Contrast SDK object
     * @param organizationUuid uuid of the organization
     */
    public static List<VulnerabilityType> saveRules(ContrastSDK sdk, String organizationUuid) {
        Rules rules;
        List<VulnerabilityType> vulnerabilityTypes = new ArrayList<>();

        try {
            rules = sdk.getRules(organizationUuid);
        } catch (IOException | UnauthorizedException e) {
            return vulnerabilityTypes;
        }

        for (Rules.Rule rule: rules.getRules()) {
            vulnerabilityTypes.add(new VulnerabilityType(rule.getName(), rule.getTitle()));
        }

        return  vulnerabilityTypes;
    }

    public static final List<String> SEVERITIES = Arrays.asList("Note", "Low", "Medium", "High", "Critical");
}


