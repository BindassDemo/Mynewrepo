<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:f="/lib/form" xmlns:st="jelly:stapler">

    <f:section title="Application Vulnerability Security Controls">
        <f:entry title="Contrast Connection" field="teamServerProfileName">
            <f:select/>
        </f:entry>




        <f:entry title="Applications">
                <f:repeatable field="conditions" add="Add Another Application">
                    <table width="100%">
                        <f:radioBlock checked="${(instance.applicationState == null) ? 'true' : instance.applicationState == 0}" name="${instance.hashCode()}.applicationState" title="Contrast has already intrumented my application" value="0" inline="true">
                            <f:entry title="Choose your application" help="/plugin/contrast-continuous-application-security/help-applicationId.html" field="applicationId">
                                <f:combobox />
                            </f:entry>
                        </f:radioBlock>

                        <f:radioBlock checked="${instance.applicationState == 1}" name="${instance.hashCode()}.applicationState" title="Contrast has not yet instrumented my application" value="1" help="/plugin/contrast-continuous-application-security/help-applicationNotInstrumented.html" inline="true">
                            <f:dropdownList name="applicationDefinition"> <!-- dropdownlist is not sending value, base persistence on the existance of fields -->
                                <f:dropdownListBlock title="Expected Application Name" selected="${instance.applicationDefinition.applicationOriginName != null}" value="0">
                                    <f:entry title="Application Name" field="applicationOriginName" help="/plugin/contrast-continuous-application-security/help-applicationName.html">
                                        <f:textbox />
                                    </f:entry>
                                    <f:entry title="Application Language" field="agentType">
                                        <f:select />
                                    </f:entry>
                                    <f:entry>
                                        <f:checkbox checked="${(instance.failOnAppNotFound == null) ? 'true' : instance.failOnAppNotFound}" title="Fail my Jenkins job if Contrast is unable to find my application with name and language provided" name="failOnAppNotFound" field="failOnAppNotFound" />
                                    </f:entry>
                                </f:dropdownListBlock>
                            </f:dropdownList>
                        </f:radioBlock>

                        <f:entry title="Number of Allowed Vulnerabilities" field="thresholdCount"
                                 help="/plugin/contrast-continuous-application-security/help-thresholdCount.html">
                            <f:number name="thresholdCount" field="thresholdCount" default="0"
                                      clazz="required positive-number"/>
                        </f:entry>

                        <f:entry title="Vulnerability Severity" field="thresholdSeverity"
                                 help="/plugin/contrast-continuous-application-security/help-thresholdSeverity.html">
                            <f:select/>
                        </f:entry>

                        <f:entry title="Vulnerability Type" field="thresholdVulnType"
                                 help="/plugin/contrast-continuous-application-security/help-thresholdVulnType.html">
                            <f:select/>
                        </f:entry>

                        <f:entry title="Vulnerability Statuses" help="/plugin/contrast-continuous-application-security/help-vulnerabilityStatus.html">
                            <f:checkbox title="Auto-Remediated" name="autoRemediated" field="autoRemediated"/>
                        </f:entry>

                        <f:entry>
                            <f:checkbox title="Not a Problem" name="notAProblem" field="notAProblem"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Fixed" name="fixed" field="fixed"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Confirmed" name="confirmed" field="confirmed"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Remediated" name="remediated" field="remediated"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Being Tracked" name="beingTracked" field="beingTracked"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Suspicious" name="suspicious" field="suspicious"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Reported" name="reported" field="reported"/>
                        </f:entry>
                        <f:entry>
                            <f:checkbox title="Untracked" name="untracked" field="untracked"/>
                        </f:entry>

                        <f:entry title="">
                            <div align="right">
                                <f:repeatableDeleteButton/>
                            </div>
                        </f:entry>
                    </table>
                </f:repeatable>
        </f:entry>
        <f:entry>
            <f:checkbox title="Override Vulnerability Security Controls at the Jenkins system level" name="overrideGlobalThresholdConditions" field="overrideGlobalThresholdConditions"/>
        </f:entry>

        <f:entry title="Query vulnerabilities by" field="queryBy" >
            <f:entry help="/plugin/contrast-continuous-application-security/help-queryBy-appVersionTag.html">
                <f:radio name="queryBy" title="appVersionTag, format: applicationId-buildNumber" value="1" checked="true" />
            </f:entry >
            <f:entry help="/plugin/contrast-continuous-application-security/help-queryBy-appVersionTagBuildName.html">
                <f:radio name="queryBy" title="appVersionTag, format: applicationId-buildName-buildNumber" value="2" checked="${instance.queryBy == 2}" />
            </f:entry>
            <f:entry help="/plugin/contrast-continuous-application-security/help-queryBy-startDate.html">
                <f:radio name="queryBy" title="startDate (Build timestamp)" value="3" checked="${instance.queryBy == 3}" />
            </f:entry>
            <f:entry help="/plugin/contrast-continuous-application-security/help-queryBy-parameter.html">
                <f:radio name="queryBy" title="APPVERSIONTAG" value="4" checked="${instance.queryBy == 4}" />
            </f:entry>
        </f:entry>
    </f:section>
    <style>
        #jenkins .jenkins-config table .repeated-chunk, #jenkins .jenkins-config table tr[nameref^="rowSetStart"], #jenkins .jenkins-config table tr[nameref^="cb"], #jenkins .jenkins-config table tr[nameref^="radio-block"] {
            border : none;
        }

        #jenkins .jenkins-config table .hetero-list-container, #jenkins .jenkins-config table .repeated-container, #jenkins .jenkins-config table tr.optional-block-start, #jenkins .jenkins-config table tr.radio-block-start {
            border : none;
        }
    </style>
    <script>
        var overrideGlobalThresholdConditionsCheckboxElements =
        document.getElementsByName("overrideGlobalThresholdConditions");
        var teamServerProfileSelectElements = document.getElementsByName("_.teamServerProfileName");

        <!-- All the fields of a Threshold Condition except the application id will be hidden if the global threshold conditions are used -->
        var thresholdCountElements = document.getElementsByName("thresholdCount");
        var thresholdSeverityElements = document.getElementsByName("_.thresholdSeverity");
        var thresholdVulnTypeElements = document.getElementsByName("_.thresholdVulnType");
        var autoRemediatedElements = document.getElementsByName("autoRemediated");
        var notAProblemElements = document.getElementsByName("notAProblem");
        var fixedElements = document.getElementsByName("fixed");
        var confirmedElements = document.getElementsByName("confirmed");
        var remediatedElements = document.getElementsByName("remediated");
        var beingTrackedElements = document.getElementsByName("beingTracked");
        var suspiciousElements = document.getElementsByName("suspicious");
        var reportedElements = document.getElementsByName("reported");
        var untrackedElements = document.getElementsByName("untracked");
        var conditionTitle = document.getElementsByName("conditionTitle");

        var dynamicElements = [];
        dynamicElements.push(thresholdCountElements);
        dynamicElements.push(thresholdSeverityElements);
        dynamicElements.push(thresholdVulnTypeElements);
        dynamicElements.push(autoRemediatedElements);
        dynamicElements.push(notAProblemElements);
        dynamicElements.push(fixedElements);
        dynamicElements.push(confirmedElements);
        dynamicElements.push(remediatedElements);
        dynamicElements.push(beingTrackedElements);
        dynamicElements.push(suspiciousElements);
        dynamicElements.push(reportedElements);
        dynamicElements.push(untrackedElements);

        <!-- When Threshold Conditions are added to the page, observer hides all of their fields except the app name if needed -->
        var observer = new MutationObserver(function(mutations) {

            if (teamServerProfileSelectElements[0] != undefined &amp;&amp; teamServerProfileSelectElements[0].onchange == null){
                <!-- Hide fields if a teamserver profile selected with isAllowGlobalThresholdConditionsOverride variable set to false  -->
                teamServerProfileSelectElements[0].onchange = function() {isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value);};
            }
            if (overrideGlobalThresholdConditionsCheckboxElements[0] != undefined &amp;&amp; overrideGlobalThresholdConditionsCheckboxElements[0].onchange == null) {
                <!-- Hide fields if the user chooses to use global conditions  -->
                overrideGlobalThresholdConditionsCheckboxElements[0].onchange = function() { isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value); };
            }

            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0 &amp;&amp; mutation.target.className == "repeated-container") {
                    isAllowGlobalThresholdConditionsOverride(teamServerProfileSelectElements[0].value);
                }
            });
        });

        observer.observe(document.querySelector("form[name=config]"), { childList: true, subtree: true });
        <!---->

        <!-- Create a proxy variable to access the descriptor of VulnerabilityTrendRecorder.java class -->
        var descriptorImpl =
        <st:bind value="${descriptor}"/>

        <!-- Checks if 'isAllowGlobalThresholdConditionsOverride' variable is set to true in the selected TeamServer profile -->
        function isAllowGlobalThresholdConditionsOverride(teamServerProfileName) {
            descriptorImpl.isAllowGlobalThresholdConditionsOverride(teamServerProfileName, function(t){
                if (t.responseObject()) {
                    overrideGlobalThresholdConditionsCheckboxElements[0].disabled = false;

                    for (var i = 0; i &lt; dynamicElements.length; i++) {
                        for (var j = 0; j &lt; dynamicElements[i].length; j++) {
                            if (overrideGlobalThresholdConditionsCheckboxElements[0].checked) {
                                dynamicElements[i][j].parentNode.parentNode.style.display = "";
                            } else {
                                dynamicElements[i][j].parentNode.parentNode.style.display = "none";
                            }

                        }
                    }


                } else {
                    overrideGlobalThresholdConditionsCheckboxElements[0].disabled = true;
                    overrideGlobalThresholdConditionsCheckboxElements[0].checked = false;

                    for (var i = 0; i &lt; dynamicElements.length; i++) {
                        for (var j = 0; j &lt; dynamicElements[i].length; j++) {
                            dynamicElements[i][j].parentNode.parentNode.style.display = "none";
                        }
                    }
                }
            });
        }
    </script>

</j:jelly>
