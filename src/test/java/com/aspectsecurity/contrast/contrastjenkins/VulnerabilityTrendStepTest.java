package com.aspectsecurity.contrast.contrastjenkins;

import com.contrastsecurity.exceptions.UnauthorizedException;
import com.contrastsecurity.http.TraceFilterForm;
import com.contrastsecurity.models.JobOutcomePolicy;
import com.contrastsecurity.models.Organization;
import com.contrastsecurity.models.Organizations;
import com.contrastsecurity.models.SecurityCheck;
import com.contrastsecurity.models.Traces;
import com.contrastsecurity.sdk.ContrastSDK;
import hudson.AbortException;
import hudson.model.Result;
import hudson.model.Run;
import hudson.model.TaskListener;
import jenkins.model.Jenkins;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;

import java.io.IOException;
import java.io.PrintStream;

import static org.junit.Assert.assertNull;
import static org.mockito.BDDMockito.given;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.anyString;
import static org.mockito.Mockito.doNothing;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.powermock.api.mockito.PowerMockito.doReturn;
import static org.powermock.api.mockito.PowerMockito.mock;
import static org.powermock.api.mockito.PowerMockito.spy;


@RunWith(PowerMockRunner.class)
@PrepareForTest({Jenkins.class, VulnerabilityTrendStep.class, VulnerabilityTrendHelper.class})
public class VulnerabilityTrendStepTest {

    @Mock
    TaskListener taskListenerMock;
    @Mock
    PrintStream printStreamMock;
    @Mock
    Jenkins jenkins;
    @Mock
    VulnerabilityTrendHelper vulnerabilityTrendHelper;
    @Mock
    VulnerabilityTrendStep.VulnerabilityTrendStepDescriptorImpl vulnerabilityTrendStepDescriptor;

    @Before
    public void setUp() {
        PowerMockito.mockStatic(Jenkins.class);
        PowerMockito.mockStatic(VulnerabilityTrendStep.class);
        PowerMockito.mockStatic(VulnerabilityTrendHelper.class);

        when(jenkins.getDescriptorByType(VulnerabilityTrendStep.VulnerabilityTrendStepDescriptorImpl.class)).thenReturn(vulnerabilityTrendStepDescriptor);
    }

    @Test
    public void testSuccessfulBuild() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, null, null, "WebGoat", Constants.QUERY_BY_APP_VERSION_TAG_DEFAULT_FORMAT);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(0);

        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);

        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);

        TeamServerProfile profile = mock(TeamServerProfile.class);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        assertNull(stepExecution.run());
    }

    @Test
    public void testSuccessfulBuildWithParameter() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, null, null, "WebGoat", Constants.QUERY_BY_PARAMETER);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(0);

        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);

        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);

        TeamServerProfile profile = mock(TeamServerProfile.class);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        assertNull(stepExecution.run());
    }

    @Test
    public void testUnsuccessfulBuild() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, "xss", "High", "WebGoat", Constants.QUERY_BY_APP_VERSION_TAG_DEFAULT_FORMAT);
        stepExecution.build = mock(Run.class);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(11);


        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);
        SecurityCheck undifinedPolicySecurityCheck = mock(SecurityCheck.class);
        given(undifinedPolicySecurityCheck.getResult()).willReturn(null);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);
        given(VulnerabilityTrendHelper.applicationIdExists(any(ContrastSDK.class), anyString(), anyString())).willReturn(true);
        given(VulnerabilityTrendHelper.makeSecurityCheck(any(ContrastSDK.class), anyString(), anyString())).willReturn(undifinedPolicySecurityCheck);

        TeamServerProfile profile = mock(TeamServerProfile.class);
        given(profile.getVulnerableBuildResult()).willReturn(Result.UNSTABLE.toString());
        given(profile.isApplyVulnerableBuildResultOnContrastError()).willReturn(true);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);
        given(VulnerabilityTrendHelper.getAllTraces(any(ContrastSDK.class), anyString(), anyString(), any(TraceFilterForm.class))).willReturn(tracesMock);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        assertNull(stepExecution.run());
        verify(stepExecution.build).setResult(Result.fromString(profile.getVulnerableBuildResult()));
    }

    @Test
    public void testUnsuccessfulBuildJop() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, "xss", "High", "WebGoat", Constants.QUERY_BY_APP_VERSION_TAG_DEFAULT_FORMAT);
        stepExecution.build = mock(Run.class);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(11);

        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        JobOutcomePolicy jobOutcomePolicy = mock(JobOutcomePolicy.class);
        when(jobOutcomePolicy.getOutcome()).thenReturn(JobOutcomePolicy.Outcome.UNSTABLE);

        SecurityCheck undifinedPolicySecurityCheck = mock(SecurityCheck.class);
        when(undifinedPolicySecurityCheck.getResult()).thenReturn(false);
        when(undifinedPolicySecurityCheck.getJobOutcomePolicy()).thenReturn(jobOutcomePolicy);



        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);
        given(VulnerabilityTrendHelper.applicationIdExists(any(ContrastSDK.class), anyString(), anyString())).willReturn(true);
        given(VulnerabilityTrendHelper.makeSecurityCheck(any(ContrastSDK.class), anyString(), anyString())).willReturn(undifinedPolicySecurityCheck);
        given(VulnerabilityTrendHelper.getJenkinsResultFromJobOutcome(any(JobOutcomePolicy.Outcome.class))).willReturn(Result.UNSTABLE);

        TeamServerProfile profile = mock(TeamServerProfile.class);
        given(profile.getVulnerableBuildResult()).willReturn(Result.UNSTABLE.toString());
        given(profile.isApplyVulnerableBuildResultOnContrastError()).willReturn(false);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);
        given(VulnerabilityTrendHelper.getAllTraces(any(ContrastSDK.class), anyString(), anyString(), any(TraceFilterForm.class))).willReturn(tracesMock);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        assertNull(stepExecution.run());
        verify(stepExecution.build).setResult(Result.fromString(profile.getVulnerableBuildResult()));

    }


    @Test(expected = AbortException.class)
    public void testVulnerableBuildFailureSelected() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, "xss", "High", "WebGoat", Constants.QUERY_BY_APP_VERSION_TAG_DEFAULT_FORMAT);
        stepExecution.build = mock(Run.class);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(11);

        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        SecurityCheck undifinedPolicySecurityCheck = mock(SecurityCheck.class);
        given(undifinedPolicySecurityCheck.getResult()).willReturn(null);


        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);
        given(VulnerabilityTrendHelper.applicationIdExists(any(ContrastSDK.class), anyString(), anyString())).willReturn(true);
        given(VulnerabilityTrendHelper.makeSecurityCheck(any(ContrastSDK.class), anyString(), anyString())).willReturn(undifinedPolicySecurityCheck);

        TeamServerProfile profile = mock(TeamServerProfile.class);
        given(profile.getVulnerableBuildResult()).willReturn(Result.FAILURE.toString());
        given(profile.isApplyVulnerableBuildResultOnContrastError()).willReturn(false);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);
        given(VulnerabilityTrendHelper.getAllTraces(any(ContrastSDK.class), anyString(), anyString(), any(TraceFilterForm.class))).willReturn(tracesMock);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        stepExecution.run();
    }

    @Test(expected = AbortException.class)
    public void testVulnerableBuildFailureSelectedJOP() throws Exception {
        VulnerabilityTrendStep.Execution stepExecution = spy(new VulnerabilityTrendStep.Execution());
        stepExecution.step = new VulnerabilityTrendStep("local", 10, "xss", "High", "WebGoat", Constants.QUERY_BY_APP_VERSION_TAG_DEFAULT_FORMAT);
        stepExecution.build = mock(Run.class);

        when(Jenkins.getInstance()).thenReturn(jenkins);

        stepExecution.taskListener = taskListenerMock;

        when(taskListenerMock.getLogger()).thenReturn(printStreamMock);
        doNothing().when(printStreamMock).println();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(11);

        ContrastSDK contrastSDKMock = mock(ContrastSDK.class);

        Organizations mockOrgs = mock(Organizations.class);
        Organization mockOrg = mock(Organization.class);
        when(mockOrgs.getOrganization()).thenReturn(mockOrg);
        given(contrastSDKMock.getProfileDefaultOrganizations()).willReturn(mockOrgs);

        JobOutcomePolicy jobOutcomePolicy = mock(JobOutcomePolicy.class);
        when(jobOutcomePolicy.getOutcome()).thenReturn(JobOutcomePolicy.Outcome.FAIL);

        SecurityCheck undifinedPolicySecurityCheck = mock(SecurityCheck.class);
        when(undifinedPolicySecurityCheck.getResult()).thenReturn(false);
        when(undifinedPolicySecurityCheck.getJobOutcomePolicy()).thenReturn(jobOutcomePolicy);



        doReturn("test").when(stepExecution).getBuildName();

        given(VulnerabilityTrendHelper.createSDK(anyString(), anyString(), anyString(), anyString())).willReturn(contrastSDKMock);
        given(VulnerabilityTrendHelper.applicationIdExists(any(ContrastSDK.class), anyString(), anyString())).willReturn(true);
        given(VulnerabilityTrendHelper.makeSecurityCheck(any(ContrastSDK.class), anyString(), anyString())).willReturn(undifinedPolicySecurityCheck);
        given(VulnerabilityTrendHelper.getJenkinsResultFromJobOutcome(any(JobOutcomePolicy.Outcome.class))).willReturn(Result.FAILURE);

        TeamServerProfile profile = mock(TeamServerProfile.class);
        given(profile.getVulnerableBuildResult()).willReturn(Result.FAILURE.toString());
        given(profile.isApplyVulnerableBuildResultOnContrastError()).willReturn(false);

        given(VulnerabilityTrendHelper.getProfile(anyString())).willReturn(profile);
        given(VulnerabilityTrendHelper.getAllTraces(any(ContrastSDK.class), anyString(), anyString(), any(TraceFilterForm.class))).willReturn(tracesMock);

        when(contrastSDKMock.getTracesInOrg(anyString(), any(TraceFilterForm.class))).thenReturn(tracesMock);

        stepExecution.run();
    }


}