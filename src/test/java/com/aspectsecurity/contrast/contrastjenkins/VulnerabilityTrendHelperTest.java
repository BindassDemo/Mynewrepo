package com.aspectsecurity.contrast.contrastjenkins;

import com.contrastsecurity.models.Trace;
import com.contrastsecurity.models.Traces;
import hudson.model.AbstractProject;
import hudson.model.ItemGroup;
import hudson.model.Job;
import hudson.model.Run;
import junit.framework.TestCase;
import org.junit.Test;
import org.mockito.Mockito;

import java.util.ArrayList;
import java.util.List;

import static org.mockito.Mockito.when;
import static org.powermock.api.mockito.PowerMockito.mock;

public class VulnerabilityTrendHelperTest extends TestCase {

    @Test
    public void testGetVulnerabilityInfoString() {
        Trace traceMock = mock(Trace.class);
        when(traceMock.getSeverity()).thenReturn("Medium");

        Trace traceMock2 = mock(Trace.class);
        when(traceMock2.getSeverity()).thenReturn("High");

        List<Trace> traces = new ArrayList<>();
        traces.add(traceMock);
        traces.add(traceMock2);

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(2);
        when(tracesMock.getTraces()).thenReturn(traces);

        String info = VulnerabilityTrendHelper.getVulnerabilityInfoString(tracesMock);
        assertEquals("Found vulnerabilities: Medium - 1 High - 1 .", info);
    }

    @Test
    public void testGetVulnerabilityInfoStringEmptyTraces() {

        List<Trace> traces = new ArrayList<>();

        Traces tracesMock = mock(Traces.class);
        when(tracesMock.getCount()).thenReturn(0);
        when(tracesMock.getTraces()).thenReturn(traces);

        String info = VulnerabilityTrendHelper.getVulnerabilityInfoString(tracesMock);
        assertEquals("", info);
    }

    @Test
    public void testGetVulnerabilityInfoStringNullTraces() {

        String info = VulnerabilityTrendHelper.getVulnerabilityInfoString(null);
        assertEquals("", info);
    }

    @Test
    public void testBuildAppVersionTagHierarchical() {
        String parentFullName = "project";
        int buildNumber = 1;
        String applicationId = "NodeTestBench";
        String appVersionTagActual = applicationId + "-" + parentFullName + "-" + buildNumber;

        Run<?, ?> build = mock(Run.class);

        Job parent = mock(Job.class);
        ItemGroup itemGroup = mock(ItemGroup.class);
        when(itemGroup.getFullName()).thenReturn("");
        when(parent.getParent()).thenReturn(itemGroup);

        when(build.getNumber()).thenReturn(buildNumber);
        when(build.getParent()).thenReturn(parent);
        when(parent.getFullName()).thenReturn(parentFullName);

        String appVersionTag = VulnerabilityTrendHelper.buildAppVersionTagHierarchical(build, applicationId);
        assertEquals(appVersionTag, appVersionTagActual);
    }
}
